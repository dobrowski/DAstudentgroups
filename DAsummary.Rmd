---
title: "DA Summary Info"
output:
  html_document: null
  theme: readable
  pdf_document: default
params:
  dist: '27661590000000'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE , message=FALSE)



library(here)
library(rmarkdown)
library(knitr)
library(tidyverse)
library(glue)
library(readxl)
library(MCOE)
library(ggthemes)
library(reactable)
library(googlesheets4)

options(scipen=999)

# 27661590000000 Salinas Union
# 27660680000000  SoMoCo
# 27660350000000 GReenfield
# 27661910000000 Santa Rita


dist <- params$dist

con <- MCOE::mcoe_sql_con()

sheet_id <- "https://docs.google.com/spreadsheets/d/1_EmvLQq-cUe8Ist_WYGJFgdjD27dajpfSbEd_djvbsc/edit#gid=0"

codebook <- read_sheet(sheet_id,
                       col_types = "ccccccD")

thresh <- tribble(
    ~ "ind", ~"threshold", ~"direction",
    "chronic", .2, "lower",
    "grad", .68, "higher",
    "cci", .099, "higher",
    "susp", .09, "lower",
    "elpi",.35, "higher"
)




da.mry.grp <- read_rds(here("data","da-mry-grp.rds"))


priors <- tribble(~ "Priority Area", ~ "Criteria", ~"Indicators",
                 "P4","Red on ELA and Math, Red on one and Orange on other for ELA Math, Red on ELPI", c("ela", "math", "elpi"),
                 "P5","Red on graduation or Red on chronic absenteeism", c("grad","chronic"),
                 "P6", "Red on Suspension", "susp",
                 "P8","Red on College/Career", "cci"
                 )


da.mry.grp.split <- da.mry.grp %>%
    mutate(P4 = if_else(str_detect(Description,"4") , TRUE,FALSE),
           P5 = if_else(str_detect(Description,"5") , TRUE,FALSE),
           P6 = if_else(str_detect(Description,"6") , TRUE,FALSE),
           P8 = if_else(str_detect(Description,"8") , TRUE,FALSE))  %>%
    pivot_longer(cols = P4:P8,
                 names_to = "Priority Area",
                 values_to = "Met",
                 names_repair = "unique") %>%
    filter(Met == TRUE) %>%
    left_join(priors)



# Determine list of student groups of interest

grouper <- da.mry.grp %>%
    filter(CDS == dist) %>%
    select(name) %>%
    distinct() %>%
    unlist()

dist.name <- da.mry.grp %>%
    filter(CDS == dist) %>%
    select(LEAname) %>%
    distinct() %>%
    unlist()

# Determine list of indicators of interest

inders.used <- all.colors <- tbl(con, "DASH_ALL") %>%
        filter(#county_code == "27",
            CDScode == dist,
            rtype == "D",
            countyname == "Monterey",
        ) %>% 
  select(year, ind) %>%
        collect() %>%
    filter(year == max(year)) %>%
  distinct() %>%
  select(ind) %>%
  unlist()

inders <- da.mry.grp.split %>%
    filter(CDS == dist) %>%
    select(Indicators) %>%
    distinct() %>%
  filter(Indicators != 'c("ela", "math", "elpi")') %>%
    unlist() %>% 
  intersect(inders.used)

inders.acad <- da.mry.grp.split %>%
    filter(CDS == dist) %>%
    select(Indicators) %>%
    distinct() %>%
  filter(Indicators == 'c("ela", "math", "elpi")') %>%
    unlist() 


inders.acad <-  if("EL" %in% grouper) inders.acad  else inders.acad[inders.acad != "elpi"]
                                  


```



---
title: `r dist.name` Differentiated Assistance Summary Report
---


## Report Purpose


This report is created to synthesize information to assist districts in reflecting on the student groups for whom indicators led to Differentiated Assistance. 


## Latest Status by Group

The graphic below shows the color for each student group for each indicator for which a color was generated by the dashboard.  This reflects the latest available colors from the 2019 dashbaord. 

```{r status}

pal <- c("0" = "white",
         "1" = "red",
         "2" = "orange",
         "3" = "yellow",
         "4" = "green",
         "5" = "blue")

cd.students <- codebook %>% 
    filter(table == "DASH_SUSP",
           field_name == "studentgroup") %>%
    select(studentgroup = variable, studentgroup_long = definition)


all.colors <- tbl(con, "DASH_ALL") %>%
        filter(#county_code == "27",
          #  districtname == "Salinas U High" ,
            CDScode == dist,

            rtype == "D",
   #         ind == indi,
            # studentgroup == "ALL"
            countyname == "Monterey",
        ) %>% 
        collect() %>%
    mutate(combo.name = paste0(districtname," - ",schoolname),
           bestname = if_else(rtype =="D",districtname,schoolname)) %>%
    filter(year == max(year)) %>%
    left_join(cd.students) %>%
    filter(color.factor != 0)


ggplot(all.colors, aes(ind, y = fct_rev(studentgroup_long))) + 
    geom_tile(aes(fill = color.factor)) +
    lemon::facet_rep_wrap(~bestname, repeat.tick.labels = TRUE) + # If not using lemon, jsut use facet_wrap
    scale_fill_manual(values = pal) +
    theme_minimal()  +
    theme(legend.position = "none") +
    labs(x="",
         y="",
         title = paste0("Dashboard Colors by Student Group" ),
  #       subtitle = "For latest available year",
         caption = paste0("https://www.caschooldashboard.org/reports/",dist,"/2019")
    )


```



## Qualifying Groups


```{r qualifying}

da.mry.grp.split %>%
    filter(CDS == dist) %>%
    select(Year, name,`Priority Area`, Criteria )  %>%
    reactable(groupBy = c("Year", "name"),
                         defaultExpanded = FALSE,
                         resizable = TRUE)

```


## Historical Graphs for Eligible Groups 



```{r historic}

graphit <- function(indi, groups){
    tbl(con, "DASH_ALL") %>%
        filter(#county_code == "27",
          #  districtname == "Salinas U High" ,
            CDScode == dist,
            #      YEAR == max(YEAR),
            rtype == "D",
            ind == indi,
            # studentgroup == "ALL"
            countyname == "Monterey",
        ) %>% 
        collect() %>%
        filter(studentgroup %in% groups) %>%
        ggplot(aes(y = currstatus/100, group = studentgroup, x = year, color = studentgroup)) +
        geom_line() +
        geom_point() +
        mcoe_theme +
        scale_color_few() + 
        scale_y_continuous(breaks = scales::breaks_extended(8), 
                           labels = scales::percent,
                           expand = expansion(c(0.1, 0.1)) ) +
  labs(title = paste0( case_when( indi == "susp" ~ "Suspension",
                                        indi == "grad" ~ "Graduation Rate",
                                        indi == "cci" ~ "College / Career",
                                        indi == "chronic" ~ "Chronic Absenteeism",
                                        indi == "elpi" ~ "English Language Progress",
                                        indi == "math" ~ "Math",
                                        indi == "ela" ~ "English Language Arts"),
                            " Historical Rates for ",
                            dist.name),
             caption = "https://www.cde.ca.gov/ta/ac/cm/index.asp",
             color = "")
    
}

for (i in inders) {

p <- graphit(i,c("ALL", grouper))
print(p)
}


graphit.acad <- function(indi, groups){
    tbl(con, "DASH_ALL") %>%
        filter(#county_code == "27",
          #  districtname == "Salinas U High" ,
            CDScode == dist,
            #      YEAR == max(YEAR),
            rtype == "D",
            ind == indi,
            # studentgroup == "ALL"
            countyname == "Monterey",
        ) %>% 
        collect() %>%
        filter(studentgroup %in% groups) %>%
        ggplot(aes(y = currstatus, group = studentgroup, x = year, color = studentgroup)) +
        geom_line() +
        geom_point() +
        mcoe_theme +
        scale_color_few() + 
        scale_y_continuous(breaks = scales::breaks_extended(8), 
                           expand = expansion(c(0.1, 0.1)) ) +
  labs(title = paste0( case_when( indi == "susp" ~ "Suspension",
                                        indi == "grad" ~ "Graduation Rate",
                                        indi == "cci" ~ "College / Career",
                                        indi == "chronic" ~ "Chronic Absenteeism",
                                        indi == "elpi" ~ "English Language Progress",
                                        indi == "math" ~ "Math",
                                        indi == "ela" ~ "English Language Arts"),
                            " Historical Rates for ",
                            dist.name),
             caption = "https://www.cde.ca.gov/ta/ac/cm/index.asp",
             color = "")
    
}

for (i in inders.acad[inders.acad != "elpi"]) {

p <- graphit.acad(i,c("ALL", grouper))
print(p)
}




```


## Pandemic Data for Eligible Groups 

Would need to ask the district for this or wait until CDE post things, but I donâ€™t think that will be for a while. 

* Assessment data for 2020-21
* results from school climate surveys
* course access data 
* teacher assignment information 
* Pupil engagement, with a focus on locally collected data on pupil classroom attendance and engagement
* annual IEP meetings
* assessments for eligibility for special education services
* Implementation of integrated and designated ELD instruction


## Status Needed to Avoid DA in 2022

The thresholds below are based on the Very Low status on the 5x5 grids used in 2019 and the number of students in the calculation in 2019.  Policies may change cutpoints and the student population this year may shift from 2019. 


```{r targets}

sentence <- function(indi, groups){
    tbl(con, "DASH_ALL") %>%
        filter(#county_code == "27",
            #  districtname == "Salinas U High" ,
            CDScode == dist,
           # YEAR == max(YEAR),
            rtype == "D",
            ind == indi,
            # studentgroup == "ALL"
            countyname == "Monterey",
        ) %>% 
        collect() %>%
        filter(studentgroup %in% groups) %>%
        left_join(thresh) %>%
        mutate(sentence_short = paste0(studentgroup," =~ ",
                                if_else(direction == "lower", floor( currdenom*threshold), ceiling( currdenom*threshold) ) ,
                                 " / ", currdenom),
               sentence_full = paste0(studentgroup," should have ", direction, " than ",
                                      if_else(direction == "lower", floor( currdenom*threshold), ceiling( currdenom*threshold) ) ,
                                      " students qualify based on the count in 2019 of ", currdenom, " to not be in Red.")
                   ) %>%
        filter(year == max(year)) %>%
        select(ind, threshold ,sentence_short, sentence_full)

    
}

sentence.frame  <- sentence("susp", grouper) %>%
    filter(ind == "")

for (i in inders) {
    
    temp1 <- sentence(i, grouper)
    
    sentence.frame <- sentence.frame %>%
        bind_rows(temp1)
    
}


ELdenom <- tbl(con, "DASH_ALL") %>%
        filter(#county_code == "27",
            #  districtname == "Salinas U High" ,
            CDScode == dist,
            year == 2019,
            rtype == "D",
            ind == "elpi",
             studentgroup == "EL",
            countyname == "Monterey",
        ) %>% 
        collect() %>%
  select(currdenom) %>%
  unlist()

sentence.frame.acad <- tribble(~"Indicator", ~"Threshold", ~"Summary", ~"Target",
        "ela","-70.1" ,"Each student group" , "Each student group should have a Distance from Standard (DFS) of higher than -70.1 to not be in Red" , 
        "math","-95.1" ,"Each student group" , "Each student group should have a Distance from Standard (DFS) of higher than -95.1 to not be in Red", 
        "elpi","35%" , paste0("EL =~ ", ceiling( ELdenom*.35) ," / ", ELdenom) ,
        paste0("EL should have more than ",
                                  ceiling( ELdenom*.35)  ,
                                      " students qualify based on the count in 2019 of ", ELdenom, " to not be in Red.")) %>%
  filter(Indicator %in% inders.acad)



sentence.frame %>%
    reactable(groupBy = c("ind"),
              defaultExpanded = FALSE,
              resizable = TRUE,
                columns = list(
    ind = colDef(name = "Indicator", align = "left"),
    threshold = colDef(name = "Threshold",
                       align = "right",
                       format = colFormat(percent = TRUE, digits = 1)),
    sentence_short = colDef(name = "Summary"),
    sentence_full = colDef(name = "Target")
    )
    )



sentence.frame.acad %>%
    reactable(groupBy = c("Indicator"),
              defaultExpanded = FALSE,
              resizable = TRUE,
                columns = list(
    Indicator = colDef( align = "left"),
    Threshold = colDef(
                       align = "right"),
    Summary = colDef(name = "Summary"),
    Target = colDef(name = "Target")
    )
    )
    



```


